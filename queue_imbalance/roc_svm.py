import matplotlib.pyplot as plt
from sklearn import svm

import lob

stocks = [
    '11399', '2645', '9069', '9063', '9926', '1472', '9094', '9270', '10166', '9061', '2822',
    '2651', '2051', '1865', '1243', '4060', '1221', '2368', '12456', '12327', '2094', '9064',
    '9034', '2748', '9761', '1956', '12098', '11244', '1113', '10795', '13061', '10887', '11234',
    '9062', '1769', '7858', '4154', '4218', '13003', '9067', '10508', '2057', '12534', '1907',
    '4481', '4549', '4618', '3035', '11867', '4851', '2730', '12713', '3757', '10470', '9265',
    '4799', '11618', '1388', '9086', '9058', '11583', '2050', '2197', '9268', '12552', '9065',
    '2602', '3161', '9074', '4736', '3459', '13113', '2290', '9269', '12059', '3879', '1229',
    '4695', '5836', '10484', '2890', '1694', '1080', '3107', '11038', '12417', '9266', '4320',
    '3022', '3388', '8080', '1431', '12255', '7843', '11714', '4575', '2028', '11946', '2813',
    '11869']
i = 0
rocs_areas = {}
plt.figure()


def svm_classification(df, start_idx, end_idx):
    clf = svm.SVC(probability=True, kernel='rbf')
    X = df['queue_imbalance'][start_idx:end_idx].values.reshape(-1, 1)
    y = df['mid_price_indicator'][start_idx:end_idx].values.reshape(-1, 1)
    clf.fit(X, y)
    return clf


for s in stocks:
    try:
        print('for', s)
        df, df_test = lob.load_data(s, data_dir='data/INDEX/')

        print('performing svm', s)
        reg_svm = svm_classification(df, 0, len(df))

        print('performing predictions', s)
        score = lob.plot_roc(df_test, reg_svm, stock=s)
        rocs_areas[s] = score
        print('{} (area = {})'.format(s, score))
        i += 1
        if i % 10 == 0:
            plt.savefig('plots_svm_rbf_default_{}.png'.format(i))
            plt.figure()
    except Exception as e:
        print('Exception for ', s, e)

plt.savefig('plots_svm_rbf_default_{}.png'.format(i))
print(rocs_areas)

result = {'11399': 0.59905185930242877, '2645': 0.54476980330919267, '9069': 0.56274258717367198,
          '9063': 0.54660506536216846, '9926': 0.56414163774172987, '1472': 0.5595531563952616,
          '9094': 0.56309082058806936, '9270': 0.55435411584210537, '10166': 0.55139273587834015,
          '9061': 0.53363249357741394, '2822': 0.58132381724826721, '2651': 0.57880696160711143,
          '2051': 0.58928094092488648, '1865': 0.59599345292871964, '1243': 0.61427039913106651,
          '4060': 0.55503861296184143, '1221': 0.59930251817469526, '2368': 0.59062897357454891,
          '12456': 0.55924415216848411, '12327': 0.57892279368665611, '2094': 0.57086747458055032,
          '9064': 0.53926593019532498, '9034': 0.58339675715131356, '2748': 0.56983446350219391,
          '9761': 0.56176237020854525, '1956': 0.56750720944894817, '12098': 0.63164965748636936,
          '11244': 0.53574467390949732, '1113': 0.57191322409416112, '10795': 0.62799533687345921,
          '13061': 0.55466123900430464, '10887': 0.54413549529997307, '11234': 0.60678173112482237,
          '9062': 0.54894145015937668, '1769': 0.5755949813057234, '7858': 0.58516398820581328,
          '4154': 0.57809410834321862, '4218': 0.60978927703949581, '13003': 0.52370257193786596,
          '9067': 0.54546791664546279, '10508': 0.56575443407174619, '2057': 0.58040829968350982,
          '12534': 0.58437887463041993, '1907': 0.57805315095689247, '4481': 0.60656791477213634,
          '4549': 0.54396407685881376, '4618': 0.55205016350997316, '3035': 0.55485096633107334,
          '11867': 0.55557224645719039, '4851': 0.5868567682726975, '2730': 0.58625308616197247,
          '12713': 0.57944387200980263, '3757': 0.59281659963162059, '10470': 0.57193058568329724,
          '9265': 0.55929492071468312, '4799': 0.55879848786134034, '11618': 0.61277308651621243,
          '1388': 0.55823225886564987, '9086': 0.55848346718761299, '9058': 0.53960130647579152,
          '11583': 0.55642703010462613, '2050': 0.567339905984656, '2197': 0.58576510980210372,
          '9268': 0.56391623764608623, '12552': 0.56875596155257169, '9065': 0.55863488924527627,
          '2602': 0.57098735935369604, '3161': 0.5748930664836035, '9074': 0.54127903886024131,
          '4736': 0.59535405302803246, '3459': 0.58394781670936857, '13113': 0.5824612626297212,
          '2290': 0.59196815205102504, '9269': 0.54477627107620763, '12059': 0.55696186740915943,
          '3879': 0.5588432250411357, '1229': 0.60983755773992754, '5836': 0.56039490729495589,
          '10484': 0.55609037224876368, '2890': 0.56073341729041082, '1694': 0.57496743201432987,
          '1080': 0.60002997601918462, '3107': 0.61066779852857944, '11038': 0.5796124711050209,
          '12417': 0.57888704777685718, '9266': 0.55039330775744022, '4320': 0.58435762364647359,
          '3022': 0.57239987537529025, '3388': 0.60125940576053105, '8080': 0.56060478563494609,
          '1431': 0.56594206345866371, '12255': 0.56414904543204392, '11714': 0.59015313331599151,
          '4575': 0.60133601784512003, '2028': 0.59681864363728732, '11946': 0.60626974381087195,
          '2813': 0.54579993550764694, '11869': 0.57919816206645669}
